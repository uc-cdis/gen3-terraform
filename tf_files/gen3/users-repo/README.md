# User YAML Repository Skeleton

This repository was generated by a Terraform module to serve as a **GitOps-style interface** for managing Fence users via the `user.yaml` file. It is designed to integrate with GitHub Actions and automatically synchronize with an S3 bucket used by the Kubernetes usersync CronJob.

## Repository Structure

```
.
├── users/
│   └── user.yaml                       # The main user configuration file
├── .github/
│   └── workflows/
│       └── user-yaml-push.yaml         # GitHub Action to sync to S3 on push to master
```

## Quick Start

### 1. Turn This Directory into a GitHub Repository

Once the Terraform module has output the skeleton files into a directory:

```bash
cd users-repo
git init
git remote add origin https://github.com/<your-org>/<your-repo>.git
git add .
git commit -m "Initial commit from Terraform-generated user.yaml skeleton"
```

Ensure you have the repo created within github and then push your commits into github

```bash
git push origin main
```

### 2. Set Up GitHub Secrets

To allow the GitHub Action to upload to S3, configure the following secrets in your GitHub repository:

- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

These credentials must belong to an IAM user or role that has write permissions to the S3 bucket defined in the `user-yaml-push.yaml` workflow file.

### 3. How It Works

- The GitHub Action in `.github/workflows/user-yaml-push.yaml` is triggered on every push to the `main` (or `master`) branch.
- It uploads the latest version of `users/user.yaml` to a designated S3 bucket.
- A Kubernetes **usersync CronJob** (typically deployed as part of the Gen3 platform) reads this S3 object on a scheduled basis (usually every 30 minutes).
- Any updates in the `user.yaml` file will be applied automatically during the next sync.

### 4. Editing the `user.yaml` File

You can manage and update the `user.yaml` file using the official Gen3 documentation:

[Fence `user.yaml` Guide](https://github.com/uc-cdis/fence/blob/master/docs/additional_documentation/user.yaml_guide.md)
